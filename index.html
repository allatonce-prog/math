<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Step-by-Step Math Tutor</title>
    <meta name="description"
        content="A PWA Math Tutor for kids. Learn Multiplication and Division with visual steps and voice narration.">
    <meta name="theme-color" content="#4a90e2">

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Math Tutor">
    <link rel="apple-touch-icon" href="./assets/icon-192.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./css/styles.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â—</text></svg>">
</head>

<body>

    <header>
        <button id="menu-btn" class="icon-btn" aria-label="Menu"
            style="margin: 0; margin-right: 15px; font-size: 1.8rem;">ğŸ”</button>

        <div class="logo-area">
            <h1>Math Tutor</h1>
        </div>

        <div id="star-jar" class="star-display">
            <span class="star-icon">â­</span>
            <span id="star-count">0</span>
        </div>
    </header>

    <!-- Sidebar Menu Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay hidden">
        <div class="sidebar">
            <button id="close-menu-btn" class="icon-btn" style="align-self: flex-end; margin-bottom: 2rem;">âœ–ï¸</button>

            <h3>Menu</h3>
            <button id="draw-page-btn" class="menu-item-btn" style="background: #e84393;">ğŸ¨ Free Draw</button>
            <button id="surprise-btn" class="menu-item-btn" style="background: #a29bfe;">ğŸ² Surprise Me!</button>

            <div class="divider"></div>

            <div class="sidebar-controls">
                <button id="music-toggle-btn" class="menu-item-btn secondary-btn">ğŸµ Music: Off</button>
                <button id="install-btn" class="menu-item-btn hidden check-btn">ğŸ“² Install App</button>
            </div>
        </div>
    </div>

    <main>
        <section id="input-section" class="card">
            <h2>Let's Learn!</h2>
            <div class="input-group">
                <input type="number" id="num-a" placeholder="First Number (A)" min="1" max="20">
                <select id="operation" aria-label="Choose operation">
                    <option value="add">Add (+)</option>
                    <option value="subtract">Subtract (-)</option>
                    <option value="multiply">Multiply (Ã—)</option>
                    <option value="divide">Divide (Ã·)</option>
                </select>
                <input type="number" id="num-b" placeholder="Second Number (B)" min="1" max="20">

                <div class="voice-control">
                    <label for="voice-select">Microphone:</label>
                    <select id="voice-select" aria-label="Choose voice">
                        <option value="male">ğŸ‘¨ Male Voice</option>
                        <option value="female">ğŸ‘© Female Voice</option>
                    </select>
                </div>

                <div class="quiz-control">
                    <label class="toggle-switch">
                        <input type="checkbox" id="quiz-mode-toggle">
                        <span class="slider"></span>
                    </label>
                    <span>â“ Quiz Me First!</span>
                </div>
            </div>

            <button id="solve-btn" class="primary-btn">Start ğŸš€</button>
        </section>

        <!-- Drawing Board Section -->
        <section id="drawing-section" class="hidden card" style="max-width: 800px; padding: 10px;">
            <div class="stage-header">
                <h2>Art Board ğŸ¨</h2>
                <button id="close-draw-btn" class="tool-btn">ğŸ”™ Back</button>
            </div>

            <div class="drawing-controls">
                <input type="color" id="color-picker" value="#ff6b6b" title="Choose Color">
                <input type="range" id="brush-size" min="2" max="20" value="5" title="Brush Size">
                <button id="eraser-btn" class="tool-btn">ğŸ§½ Eraser</button>
                <button id="clear-board-btn" class="tool-btn">ğŸ—‘ï¸ Clear</button>
            </div>

            <div class="canvas-container"
                style="position: relative; height: 400px; background: white; border: 4px dashed #ccc; border-radius: 20px; touch-action: none; overflow: hidden;">
                <canvas id="art-canvas"></canvas>
            </div>
        </section>

        <section id="explanation-section" class="hidden">
            <div class="stage-header">
                <div class="progress-container">
                    <div id="progress-bar"></div>
                </div>
                <!-- Chalkboard Controls -->
                <div class="tool-controls">
                    <button id="draw-toggle-btn" class="tool-btn" aria-label="Draw">âœï¸ Draw</button>
                    <button id="clear-draw-btn" class="tool-btn hidden" aria-label="Clear">âŒ</button>
                </div>
            </div>

            <div class="stage-wrapper" id="stage-wrapper">
                <!-- Canvas will be injected here by Scratchpad class -->
                <div id="step-stage">
                    <!-- Content goes here -->
                </div>
            </div>

            <div class="controls-area">
                <button id="prev-btn" class="nav-btn" disabled>â¬…ï¸ Back</button>
                <button id="replay-voice-btn" class="nav-btn secondary-btn" aria-label="Replay Audio">ğŸ”Š Hear
                    it</button>
                <button id="next-btn" class="nav-btn primary-btn">Next â¡ï¸</button>
            </div>
        </section>
    </main>

    <footer>
        <p>sample pani mga idol</p>
    </footer>

    <!-- Custom Update Notification Toast -->
    <div id="update-toast">
        <span>New version available!</span>
        <button id="reload-btn">Update Now</button>
    </div>

    <!-- Service Worker Registration & Version Manager -->
    <script>
        let newWorker;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    console.log('Service Worker registered!', reg.scope);

                    // clear old cache on load if needed or just rely on activation

                    reg.addEventListener('updatefound', () => {
                        newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // New update available
                                    showUpdateToast();
                                }
                            }
                        });
                    });
                }).catch(err => console.error('Service Worker registration failed:', err));
            });

            // Reload page when the new service worker takes control
            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                window.location.reload();
                refreshing = true;
            });
        }

        function showUpdateToast() {
            const toast = document.getElementById('update-toast');
            toast.classList.add('show');

            document.getElementById('reload-btn').addEventListener('click', () => {
                if (newWorker) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                }
            });
        }
    </script>

    <!-- Main Application Logic -->
    <script type="module" src="./js/main.js"></script>
</body>

</html>